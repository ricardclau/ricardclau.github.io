<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Running Go executables (Consul, Telegraf, ...) as windows services - Ricard Clau</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1309891-8','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Ricard Clau" rel=home><div class="logo__item logo__text"><div class=logo__title>Ricard Clau</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about-me><span class=menu__text>About me</span></a></li><li class=menu__item><a class=menu__link href=/curriculum-vitae-en><span class=menu__text>CV</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Running Go executables (Consul, Telegraf, ...) as windows services</h1></header><figure class="post__thumbnail thumbnail"><img class=thumbnail__image src=/wp-content/uploads/2016/03/gopherlovewindows.jpg alt="Running Go executables (Consul, Telegraf, ...) as windows services"></figure><div class="content post__content clearfix"><p>There are many companies building applications using <strong>C#</strong> which still predominantly run on <strong>Windows</strong> servers.</p><p><strong>Windows 2012 Server</strong> was definitely a step forward and I can´t wait to see the first <strong>headless Windows Nano servers</strong>, which is happening in <strong>Windows 2016 Server</strong>. However, the Windows ecosystem is sometimes a bit of a step behind the Linux world or has taken a completely different approach (<strong>Powershell</strong> I am looking at you).</p><p>And because of this completely different world, <strong>creating a Windows service to run a binary exe file</strong> with some arguments, which happens to be a trivial thing in the Linux world, becomes a real pain in Windows.</p><p>One of the biggest Go features is that it can generate executables for a number of architectures including <strong>ARM</strong> or <strong>Windows</strong>.</p><p>There are a lot of great <strong>DevOps</strong> tools these days written in Go, like the <strong><a href=https://www.hashicorp.com/ target=_blank>Hashicorp</a></strong> stack (Packer, Terraform, Consul&hellip;) or the <strong><a href=https://influxdata.com/time-series-platform/ target=_blank>InfluxData time-series platform</a></strong> based on the TICK stack (Telegraf, InfluxDB, Chronograf, Kapacitor). And because they are written in Go, they happen to run on Windows and you can get exe files for most of them.</p><p>You probably won´t run InfluxDB or the Consul Agent in Server mode in a Windows server but many chances are that you will want to install the <strong>Consul Agent in Client Mode</strong> or the <strong>Telegraf Agents in your Windows nodes</strong> running either your C# application or other Windows-only pieces of your stack like your SQL Server nodes or your Active Directory servers.</p><p>You may be tempted to download for instance Consul in a directory called &#8220;consul.io&#8221; and try to create a Windows Service with something like this (yeah the spaces after the = are not typos, this is actually how it works, thanks Windows&hellip;)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>sc create <span style=color:#e6db74>&#34;Consul&#34;</span> binPath<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;c:\consul.io\consul.exe agent -config-dir c:\consul.io\consul.d\someconfig --ui-dir c:\consul.io\ui&#34;</span> type<span style=color:#f92672>=</span> share start<span style=color:#f92672>=</span> auto</code></pre></div><p>Or if you try to do the same for the Telegraf agents, you will download them to a &#8220;telegraf&#8221; directory, and try this command</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>sc create <span style=color:#e6db74>&#34;Telegraf&#34;</span> binPath<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;c:\telegraf\telegraf.exe -config c:\telegraf\telegraf.config&#34;</span> type<span style=color:#f92672>=</span> share start<span style=color:#f92672>=</span> auto</code></pre></div><p>The services will be registered but then when you try to start them you will see that they end up erroring after trying for a while.</p><p>So, how can we fix that? <strong><a href=http://nssm.cc/ target=_blank>NSSM</a></strong> to the rescue! And we can install it from <a href=https://chocolatey.org/ target=_blank>chocolatey</a>! Opening our powershell session:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span><span style=color:#75715e># This will install Chocolatey</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">2</span>iex ((new-object net.webclient).DownloadString(<span style=color:#e6db74>&#39;https://chocolatey.org/install.ps1&#39;</span>))
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">4</span><span style=color:#75715e># This will download the latest NSSM</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">5</span>choco install -y nssm</code></pre></div><p>And now we can register our services with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>nssm install Consul c<span style=color:#960050;background-color:#1e0010>:</span>\consul.io\consul.exe agent -config-dir c<span style=color:#960050;background-color:#1e0010>:</span>\consul.io\consul.d\someconfig --ui-dir c<span style=color:#960050;background-color:#1e0010>:</span>\consul.io\ui</code></pre></div><p>and</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>nssm install Telegraf c<span style=color:#960050;background-color:#1e0010>:</span>\telegraf\telegraf.exe -config c<span style=color:#960050;background-color:#1e0010>:</span>\telegraf\telegraf.config</code></pre></div><p>And finally, our services will start and stop gracefully in a Windows environment!</p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Ricard Clau.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>