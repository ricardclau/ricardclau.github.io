<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Access to the raw Request body in Play Framework - Ricard Clau</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1309891-8','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Ricard Clau" rel=home><div class="logo__item logo__text"><div class=logo__title>Ricard Clau</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about-me><span class=menu__text>About me</span></a></li><li class=menu__item><a class=menu__link href=/curriculum-vitae-en><span class=menu__text>CV</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Access to the raw Request body in Play Framework</h1></header><figure class="post__thumbnail thumbnail"><img class=thumbnail__image src=/wp-content/uploads/2015/06/10-21-http-request-720x340.png alt="Access to the raw Request body in Play Framework"></figure><div class="content post__content clearfix"><p>Play Framework uses the concept of BodyParsers to read the data being sent in our HTTP requests. You can read more about this subject in <a href=https://www.playframework.com/documentation/2.4.x/JavaBodyParsers target=_blank>the official docs</a>.</p><p>As it can be seen, we can specify an <strong>explicit BodyParser</strong> in our <strong>controller actions</strong> as explained in this page but unless we have some specific need we will possibly be better delegating the right parser to the framework.</p><p>By default, Play uses the <strong>BodyParser.AnyContent</strong> class which tries to guess the best way to parse our data. Essentially, it looks at the <strong>Content-Type header</strong> in order to find out the most suitable parser and once the data stream is parsed we will have our data accessible via convenient methods.</p><p>But here is when things start to turn interesting and tricky. Play Framework uses <strong>streams</strong> to represent the HTTP request and response and this means that once the stream is parsed, you cannot parse it again. If you think about it, it makes sense but IMHO the <strong>API can be a bit misleading</strong>.</p><p>Let&#8217;s imagine we send a <strong>POST</strong> request with a Content-Type header <strong>application/json</strong> and some JSON body. As stated in the docs, if we want to access the body, we can use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>JsonNode body <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asJson</span><span style=color:#f92672>();</span></code></pre></div><p>And we will see the expected JSON body there. Play Framework uses the <strong>Jackson</strong> library by default, so we can access all the properties in a very easy way.</p><p>However, JSON is <strong>loosely typed</strong> and it has some <strong>quirks</strong> when trying to parse arbitrary data. We actually had a bit of a WTF situation last week and this was the motivation to write this post.</p><p>Imagine we are sending a JSON body which includes a double value like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">2</span>   <span style=color:#f92672>&#34;someDoubleValue&#34;</span>: <span style=color:#ae81ff>1.0</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">3</span>}</code></pre></div><p>The raw JSON body travelling through the network will contain the 1.0 as expected but if we look at what Jackson has parsed, we will see that it has converted 1.0 to 1.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>String jsonToString <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asJson</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span> 
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">2</span><span style=color:#f92672>//</span> This String will be <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;someDoubleValue&#34;</span><span style=color:#f92672>:</span> 1<span style=color:#f92672>}</span></code></pre></div><p>Arguably, this should not matter at all, and in reality, if we use one of the Jackson convenient methods, it will parse the data accordingly and we won&#8217;t even notice in 99% of the cases</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span><span style=color:#66d9ef>double</span> someDoubleValue <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asJson</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;someDoubleValue&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>asDouble</span><span style=color:#f92672>();</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">2</span><span style=color:#f92672>//</span> We will have our 1<span style=color:#f92672>.</span><span style=color:#a6e22e>0</span> again</code></pre></div><p>In our case, we are sending a special HTTP header which is a hash of the Json body. This hash is validated in the server, so the raw body should match.</p><p>The problem is that <strong>BodyParser.AnyContent</strong> will only provide the data in the format it believes is right, and a very misleading null in any other convenience methods</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">1</span>JsonNode body <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asJson</span><span style=color:#f92672>();</span> <span style=color:#75715e>// Our JSON data
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">2</span><span style=color:#75715e></span>String body <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asText</span><span style=color:#f92672>();</span> <span style=color:#75715e>// NULL unless the Content-Type is text/plain
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">3</span><span style=color:#75715e></span>RawBuffer buff <span style=color:#f92672>=</span> request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asRaw</span><span style=color:#f92672>();</span> <span style=color:#f92672>//</span> NULL <span style=color:#66d9ef>if</span> the Content<span style=color:#f92672>-</span>Type satisfies some of the other convenient access methods</code></pre></div><p>We could argue that this may be a not great API, and <strong>we should have access to the raw body</strong> no matter what but <strong>Play Framework</strong> has worked like this for a while and it does not seem to be changing any soon.</p><p>So, the only way to get back the <strong>original array of bytes in our HTTP Request body</strong> in order to be able to correctly calculate the hash is to force the use of the <strong>BodyParser.Raw</strong> class</p><p>And the way to do that is to add an <strong>annotation</strong> to our controller definition</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 1</span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyController</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 2</span>   <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ObjectMapper objectMapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectMapper<span style=color:#f92672>();</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 4</span>   <span style=color:#a6e22e>@BodyParser.Of</span><span style=color:#f92672>(</span>BodyParser<span style=color:#f92672>.</span><span style=color:#a6e22e>Raw</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 5</span>   <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>MyAction</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 6</span>        JsonNode requestData<span style=color:#f92672>;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 7</span>        String rawBody <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 8</span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 9</span>            rawBody <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>(</span>request<span style=color:#f92672>().</span><span style=color:#a6e22e>body</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asRaw</span><span style=color:#f92672>().</span><span style=color:#a6e22e>asBytes</span><span style=color:#f92672>(),</span> <span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">10</span>            requestData <span style=color:#f92672>=</span> objectMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>readValue</span><span style=color:#f92672>(</span>rawBody<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&amp;</span>lt<span style=color:#f92672>;</span>JsonNode<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">11</span>            <span style=color:#f92672>});</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">12</span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">13</span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Body was not a json: &#34;</span> <span style=color:#f92672>+</span> rawBody<span style=color:#f92672>);</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">14</span>        <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">15</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">16</span>        <span style=color:#75715e>// And at this point requestData will be the same as request().body().asJson()
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">17</span><span style=color:#75715e></span>        <span style=color:#75715e>// and rawBody will be the exact stringified JSON that was sent to the server
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">18</span><span style=color:#75715e></span>   <span style=color:#f92672>}</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">19</span><span style=color:#f92672>}</span></code></pre></div><p>All this information can be obtained <strong>reading carefully the docs</strong> but I hope a more specific post like this may be able to save some headaches to someone like it happened to us!</p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Ricard Clau.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>