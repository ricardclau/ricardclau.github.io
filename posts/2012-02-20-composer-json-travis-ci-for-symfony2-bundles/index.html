<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Composer.json and Travis-ci for our Symfony2 Bundles - Ricard Clau</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1309891-8','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Ricard Clau" rel=home><div class="logo__item logo__text"><div class=logo__title>Ricard Clau</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about-me><span class=menu__text>About me</span></a></li><li class=menu__item><a class=menu__link href=/curriculum-vitae-en><span class=menu__text>CV</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Composer.json and Travis-ci for our Symfony2 Bundles</h1></header><div class="content post__content clearfix"><p><strong>Travis-CI</strong> and <strong>Packagist / composer.json</strong> are the new toys in the PHP community and specially amongst the <strong>Symfony2 developers crew</strong>.</p><p>I like <strong>Travis-CI</strong> because you can easily setup <strong>Continous Integration</strong> to some degree without having to setup a full working <strong>Jenkins</strong> (or whatever suite) environment and code can be tested with different PHP versions. This can be really useful to ensure that our code is ready for the incoming <strong>PHP5.4</strong>. Of course, it will never be a substitute for a professionally configured Jenkins instance but can be a quite good complement to that.</p><p>And <strong>composer</strong> aims to <strong>remove dependency problems</strong> when our project needs other libraries to work.</p><p>In the <del datetime=2012-02-20T19:50:55+00:00>good</del> (well not so good) old PHP4 times old these good practices were more or less out of the table.<br>Most web pages were still quite small, there was not a big amount of open-source libraries used amongst projects, most PHP code was written from scratch and unit testing was not really needed (and not even possible, sometimes). But in the last years this has all changed (hopefully for good) and good practices are needed.</p><h3 id=so-how-can-we-do-all-this>So, how can we do all this?</h3><p>To illustrate this, I will use a small bundle I&#8217;ve been working on lately.<br>This bundle aims to complement out-of-the-box Symfony2 validator with some other validations that are quite common in web development. At the moment of writing this, only major CreditCard validations are included but more validations will be included in the following weeks.</p><p>You can see the source code in <a href=https://github.com/ricardclau/PixelavengersExtraValidatorBundle target=_blank>GitHub</a>.</p><h3 id=composer-json>Composer.json</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 1</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 2</span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;pixelavengers/extra-validator-bundle&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 3</span>    <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;This bundle provides some useful extra validators&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 4</span>    <span style=color:#f92672>&#34;keywords&#34;</span>: [<span style=color:#e6db74>&#34;validators&#34;</span>],
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 5</span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;symfony-bundle&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 6</span>    <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;MIT&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 7</span>    <span style=color:#f92672>&#34;authors&#34;</span>: [
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 8</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 9</span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Ricard Clau&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">10</span>            <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;ricard.clau@gmail.com&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">11</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">12</span>    ],
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">13</span>    <span style=color:#f92672>&#34;require&#34;</span>: {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">14</span>        <span style=color:#f92672>&#34;php&#34;</span>: <span style=color:#e6db74>&#34;&gt;=5.3.2&#34;</span>,
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">15</span>        <span style=color:#f92672>&#34;symfony/symfony&#34;</span>: <span style=color:#e6db74>&#34;2.0.*&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">16</span>    },
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">17</span>    <span style=color:#f92672>&#34;autoload&#34;</span>: {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">18</span>        <span style=color:#f92672>&#34;psr-0&#34;</span>: { <span style=color:#f92672>&#34;Pixelavengers\\Bundle\\ExtraValidatorBundle&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span> }
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">19</span>    },
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">20</span>    <span style=color:#f92672>&#34;target-dir&#34;</span>: <span style=color:#e6db74>&#34;Pixelavengers/Bundle/ExtraValidatorBundle&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">21</span>}</code></pre></div><p>This is the <strong>composer.json</strong> file content. I think it is pretty self-explanatory and inspired in other big bundle composer files. In the require section, I must admit that requiring all symfony framework to just extend validations is not necessary, and would be better to just require symfony/validator. Anyway I think that it is ok to this example but please take into account that <strong>dependencies should only be what is really needed</strong>.</p><p>It is important to have a look also at the <strong>CLI unit-testing bootstrap.php</strong> file as I had to add some lines to make it work:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 1</span><span style=color:#75715e>&lt;?php</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 2</span>$vendorDir <span style=color:#f92672>=</span> <span style=color:#66d9ef>__DIR__</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/../vendor&#39;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 4</span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#66d9ef>include</span>($vendorDir <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/.composer/autoload.php&#39;</span>)) {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 5</span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;You must set up the project dependencies, run the following commands:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 6</span><span style=color:#e6db74>wget http://getcomposer.org/composer.phar
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 7</span><span style=color:#e6db74>php composer.phar install
</span><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 8</span><span style=color:#e6db74>&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 9</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">11</span><span style=color:#a6e22e>spl_autoload_register</span>(<span style=color:#66d9ef>function</span>($class) {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">12</span>    <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>===</span> (<span style=color:#a6e22e>strpos</span>($class, <span style=color:#e6db74>&#39;Pixelavengers\\Bundle\\ExtraValidatorBundle\\&#39;</span>))) {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">13</span>        $path <span style=color:#f92672>=</span> <span style=color:#66d9ef>__DIR__</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/../&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#a6e22e>array_slice</span>(<span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#39;\\&#39;</span>, $class), <span style=color:#ae81ff>3</span>))<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;.php&#39;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">14</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">15</span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>stream_resolve_include_path</span>($path)) {
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">16</span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">17</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">18</span>        <span style=color:#66d9ef>require_once</span> $path;
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">19</span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">20</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">21</span>});
</code></pre></div><p>As you can see, CLI bootstraping first <strong>checks that composer is properly installed</strong>, otherwise it outputs an error. Composer has its own psr-0 autoload but I couldn&rsquo;t make it work without this <strong>spl_autoload_register</strong> snippet.</p><p><strong>PSR-0</strong> spec expects each namespace part to be a folder. We code our bundle to fit Symfony2 specs so that it will work as any other bundle but in this kind of projects our root directory is what would be a 4th level directory in a Symfony2 environment. For instance file <strong>Amex.php</strong> is in <strong>namespace Pixelavengers\Bundle\ExtraValidatorBundle\Validator\Constraints</strong> but inside the project it is in <strong>Validator/Constraints folder</strong>. So, first 3 namespace levels have to be &ldquo;removed&rdquo; in autoload. (This is harder to explain with words than actually seeing it).</p><p>And that&rsquo;s it, to publish our bundle to packagist we just have to create a new account in <a href=http://packagist.org target=_blank>Packagist website</a>, and submit our package supplying Github public link. And <a href=http://packagist.org/packages/pixelavengers/extra-validator-bundle target=_blank>here you can see this little bundle</a> inside Packagist.</p><h3 id=travis-ci-integration>Travis-CI Integration</h3><p>To integrate our tests with Travis-CI, a .travis.yml file must be created in the root of our project similar to this.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 1</span>language: php
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 3</span>php:
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 4</span>  - <span style=color:#ae81ff>5.3</span>.<span style=color:#ae81ff>2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 5</span>  - <span style=color:#ae81ff>5.3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 6</span>  - <span style=color:#ae81ff>5.4</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 7</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 8</span>before_script:
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79"> 9</span>  - wget http://getcomposer.org/composer.phar
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">10</span>  - php composer.phar install
<span style="margin-right:.4em;padding:0 .4em;color:#7c7c79">11</span>  - phpunit</code></pre></div><p>As you can see, we setup our project to be executed with 3 different PHP versions: 5.3.2 (still minimal SF2 requirements), 5.3 (which will use latest in Travis environments, right now it is 5.3.10) and 5.4.</p><p>And finally, <strong>before_script</strong> key is an array of <strong>commands to be executed before starting tests</strong>. In our case, we just have to download composer, install it and launch phpunit.</p><p>And to <strong>link our Github repository to Travis-CI</strong>, we just have to login to <a href=http://travis-ci.org target=_blank>Travis-CI website</a> with our Github account, and tell Travis which repositories are to be included.<br>What this does in the background is actually <strong>setup a service hook from Github to Travis-CI</strong>, and of course can also be setup manually in the Github side quite easily.</p><p>And that&rsquo;s it, any new push to our repository will automatically launch Unit Tests in travis-ci.</p><p>Credits for Travis-CI part go to my friend Christian Soronellas we set up Symfony Barcelona project Travis-CI integration and introduced me to all this stuff!</p><p>Hope you liked this little explanation! Stay tuned!</p></div></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 Ricard Clau.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>